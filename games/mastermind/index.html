<!doctype html>
<html lang="hi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mastermind ‚Äî Ravindra Games Hub</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="../../style.css">
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #222;
      color: #fff;
    }

    #gameArea {
      flex: 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #sidebar {
      width: 300px;
      background: #fff;
      border-right: 2px solid #ccc;
      padding: 20px;
      overflow-y: auto;
      height: 100vh;
    }

    h2 {
      text-align: center;
      margin-top: 0;
      color: #010101;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      background: #333;
      margin: 8px 0;
      padding: 6px 10px;
      border-radius: 6px;
    }

    .muted {
      color: #bbb;
      font-size: 12px;
    }

    table,
    th,
    td {
      color: #bbb;
      border: 1px solid #d9d8d8;
      box-shadow: 0 0.5vw 2.5vw 0 rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <aside id="sidebar">
    <h2>üèÜ Leaderboard</h2>
    <div id="leaderboardList">Loading...</div>
  </aside>
  <div class="container">
    <h1>Mastermind (4 slots, 6 colors)</h1>
    <div id="gameArea">
      <div><button id="guessBtn" class="chip">Make Guess</button><button id="restart" class="chip">Restart</button>
      </div>
      <div>
        <p id="secret">Code is</p>
        <p id="choice">Guess Code is</p>
      </div>
    </div>

    <script type="module">
      import { renderLeaderboard } from "./leaderboard/leaderboard.js";

      window.addEventListener("DOMContentLoaded", () => {
        renderLeaderboard("mastermind", "#leaderboard");
      });
    </script>

    <script>
      // Simple Mastermind: randomly generate code of 4 colors (0..5). Player guesses via prompts.
      let secret = Array.from({ length: 4 }, () => Math.floor(Math.random() * 6));
      console.log("secret", secret);
      let attempts = 0;
      async function makeGuess() {
        const guessStr = prompt('Enter 4 digits (0-5) e.g. 0123'); if (!guessStr) return;
        const guess = guessStr.split('').map(Number);
        attempts++;
        let exact = 0, colorOnly = 0;
        const sCopy = [...secret];
        for (let i = 0; i < 4; i++) if (guess[i] === sCopy[i]) { exact++; sCopy[i] = null; }
        for (let i = 0; i < 4; i++) {
          if (guess[i] !== secret[i]) {
            const idx = sCopy.indexOf(guess[i]); if (idx !== -1) { colorOnly++; sCopy[idx] = null; }
          }
        }
        const msg = `Attempt ${attempts}: exact=${exact}, color=${colorOnly}`;
        alert(msg);
        document.getElementById("choice").textContent = msg;
        if (exact === 4) {
          const finalScore = Math.max(0, 100 - attempts * 10); console.log("window.submitScore", window.submitScore)
          window.submitScore && window.submitScore('mastermind', finalScore); alert('Game over ‚Äî score: ' + finalScore);
        }
      }
      document.getElementById('gameArea').innerHTML = '<div><button id="guessBtn" class="chip">Make Guess</button><button id="restart" class="chip">Restart</button> </div><div><p id="secret">Code is</p><p id="choice">Guess Code is</p></div>';
      document.getElementById("secret").textContent = "Code is " + secret;
      document.getElementById('guessBtn').addEventListener('click', makeGuess);
      document.getElementById('restart').addEventListener('click', () => { secret = Array.from({ length: 4 }, () => Math.floor(Math.random() * 6)); attempts = 0; alert('New code generated'); });
    </script>

    <script>
      window.submitScore = async function (game_id, score) {
        const player_name = localStorage.getItem("player_name") || "Guest";
        const email = localStorage.getItem("email") || "";

        try {
          const res = await fetch("https://bkhoexvgorxzgdujofar.supabase.co/functions/v1/submit-score", {
            method: "POST",
            headers: {
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJraG9leHZnb3J4emdkdWpvZmFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTE3NDgsImV4cCI6MjA3NjA4Nzc0OH0.DG1jB5GDBJAtfOsJF0KjO8luVVTLTgx6MlZIvj_v7IQ",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ player_name, email, game_id, score })
          });

          const data = await res.json();
          console.log("‚úÖ Score saved:", data);
          alert("‚úÖ " + data.message);
        } catch (err) {
          console.error("‚ùå Error saving score:", err);
          alert("‚ùå Error saving score. Check console.");
        }
      };
    </script>
</body>

</html>