<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastermind game by Computer feedback by user</title>
    <!-- /Mastermind_solver/
    ‚îÇ
    ‚îî‚îÄ‚îÄ /project solver user (feedback)/
        ‚îú‚îÄ‚îÄ index.html
        ‚îú‚îÄ‚îÄ style.css
        ‚îú‚îÄ‚îÄ /js/
        ‚îÇ   ‚îú‚îÄ‚îÄ script.js
        ‚îÇ   ‚îú‚îÄ‚îÄ speak.js
        ‚îÇ   ‚îî‚îÄ‚îÄ sound.js
        ‚îî‚îÄ‚îÄ /assets/
            ‚îú‚îÄ‚îÄ /font/
            ‚îÇ   ‚îú‚îÄ‚îÄ Bangears-Regular.ttf
            ‚îÇ   ‚îú‚îÄ‚îÄ GajrajOne-Regular.ttf.ttf
            ‚îî‚îÄ‚îÄ /sound/
                ‚îú‚îÄ‚îÄ inhalation-and-exhalation.mp3
                ‚îú‚îÄ‚îÄ Clock-Ticking-one.mp3
                ‚îú‚îÄ‚îÄ fireworks.mp3
                ‚îú‚îÄ‚îÄ Looser.mp3
                ‚îú‚îÄ‚îÄ winner-trumpets.mp3
                ‚îî‚îÄ‚îÄ tap-sound.mp3      -->
    <!-- Mastermind solver
        with seperate liberary files
        with responsive layout
        with 2 downloaded font
        with dark/light theme 
        with speak in english
        with timer display
        with ledder board
        with 1 to 12 no slots choose (default 4)
            1 slot no coice
            12 slot very hard
        with 1 to 20 no colors choose (default 6)
            min colors equal to number of slots
            colors equal to slots easy
            20 colors harder
            20 colors and 12 slots hardest 
        colors with number for play color blind persion -->
    <!-- <link rel="stylesheet" href="style.css"> -->
    <style>
        :root {
            --bg: #f0f0f0;
            --text: #222;
            --border: #333;
            --gap: 1.2vw;
            --bg-hover: #9f9f9f;
            --box-shadow: rgba(0, 0, 0, 0.2);
            --card1: #0b1220;
            --card2: #0e1b2b;
            --accent: #2563eb;
            --slot-size: clamp(3.6vw, 4vw, 5.6vw);
            --peg-size: clamp(1.8vw, 3vw, 4vw);
        }

        body.dark {
            --bg: #454545;
            --text: #eee;
            --border: #d9d8d8;
            --bg-hover: #c1c1c1;
            --box-shadow: rgba(255, 255, 255, 0.3);
        }

        @font-face {
            font-family: 'HindiFontGajraj';
            src: url('assets/font/GajrajOne-Regular.ttf') format('truetype');
        }

        @font-face {
            font-family: 'EnglishFontBangers';
            src: url('assets/font/Bangers-Regular.ttf') format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            flex-wrap: wrap;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        /* Layout Responsive */
        #container {
            display: flex;
            flex-direction: row;
            height: 100%;
            padding: 0.1vw;
            background: linear-gradient(180deg, var(--card1), var(--card2));
            border-radius: 1.2vw;
            box-shadow: 0 0.6vw 1.8vw rgba(2, 6, 23, .6);
        }

        .section {
            box-sizing: border-box;
            padding: 1vw;
            overflow: hidden;
        }

        #left {
            background: var(--bg);
            padding: 0.1vw;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 30vw;
        }

        #left h1 {
            text-align: center;
            font-size: 4vw;
            font-family: 'EnglishFontBangers', Arial, Helvetica, sans-serif;
            color: var(--text);
            letter-spacing: .8vw;
            text-shadow: 0 1px 0 #030303,
                0 2px 0 #c9c9c9,
                0 3px 0 #bbb,
                0 4px 0 #b9b9b9,
                0 5px 0 #aaa,
                0 6px 1px var(--box-shadow),
                0 0 5px var(--box-shadow),
                0 1px 3px var(--box-shadow),
                0 3px 5px var(--box-shadow),
                0 5px 10px var(--box-shadow),
                0 10px 10px var(--box-shadow),
                0 20px 20px var(--box-shadow);
            margin-bottom: 0.3vw;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1vw;
            padding: 0.5vw;
            justify-content: center;
            margin-bottom: 0.5vw;
            margin-top: 0.5vw;
            width: 100%;
            box-shadow: 0 0.5vw 2.5vw 0 var(--box-shadow);
        }

        select,
        label,
        input,
        button {
            padding: 0.2vw 0.3vw;
            font-size: 1.6vw;
            margin-top: 0.1vh;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 0.5vw 2.5vw 0 var(--box-shadow);
            cursor: pointer;
            background: var(--bg);
            color: var(--text);
            border: 0.2vw solid var(--border);
        }

        select:hover {
            background: var(--bg-hover);
        }

        input:hover {
            background: var(--bg-hover);
        }

        button:hover {
            background: var(--bg-hover);
        }

        .message {
            width: 100%;
            text-align: center;
            background: var(--bg);
            margin-top: 0.1vh;
            padding: 1vw;
            border: 0.3vw dashed var(--box-shadow);
            color: var(--text);
            font-weight: bold;
            font-size: 1.5vw;
            box-shadow: 0 0.5vw 2.5vw 0 var(--box-shadow);
        }

        #right {
            background: var(--bg);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.1vw;
            justify-content: center;
        }

        @keyframes color {
            0% {
                border-color: #ffffff;
            }

            50% {
                border-color: var(--bg);
            }

            100% {
                border-color: var(--border);
            }
        }

        .feedback {
            display: flex;
            flex-wrap: wrap;
            width: 5vw;
            margin-left: 0.8vw;
            font-size: 1.6vw;

        }

        /* Portrait (Top-Bottom layout) */
        @media (max-aspect-ratio: 1/1) {
            #container {
                flex-direction: column;
            }

            #left {
                width: 100%;
                max-width: 100%;
                flex: 0 0 auto;
            }

            #right {
                flex: 1;
                width: 100%;
            }
        }

        #displayTime {
            font-family: 'Digital', Arial, Helvetica, sans-serif;
            text-align: center;
            width: auto;
            height: auto;
            font-size: 1.5vw;
            padding: 1vw 1vw;
            background: var(--bg);
            color: var(--text);
            border: none;
        }

        .board {
            display: flex;
            gap: 0.8vw;
            align-items: center;
            margin: 1.2vw 0;
            flex-wrap:wrap;
        }

        .slot {
            width:var(--slot-size);
            height:var(--slot-size);
            border-radius: 0.6vw;
            border: 0.2vw dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .slot.empty {
            background: transparent;
            border: 0.2vw dashed var(--border);
            opacity:.35;
        }

        .palette {
            display: flex;
            gap: 0.5vw;
            flex-wrap: wrap;
            justify-content: center;
        }

        .colorBtn {
            width: 2.5vw;
            height: 2.5vw;
            border-radius: 0.5vw;
            border: 0.2vw solid rgba(255, 255, 255, .06);
            cursor: pointer
        }

        .log {
            margin-top: 1.2vw;
            background: var(--bg);
            color: var(--text);
            padding: 1vw;
            border-radius: 0.8vw;
            max-height:22vw;
            overflow: auto;
            font-family: monospace;
            font-size: 1.3vw
        }

        .peg {
            width: 2vw;
            height: 2vw;
            border-radius: 0.4vw;
            border: 0.2vw solid var(--border);
        }

        .small {
            font-size: 1.3vw;
            color: var(--text);
            margin-left: 0.8vw;
        }

        #visualGuesses {
            margin-top: 1.2vw;
            display:flex;
            flex-direction:column;
            gap:0.8vw;
            max-height:36vw;
            overflow:auto;
            padding-right:0.6vw
        }
        .guessBoard {
            display: flex;
            gap: 0.4vw;
            align-items: center;
            margin-top: 0.2vw;
            padding:0.4vw;
            border-radius:0.8vw
        }

        /* feedback control styles */
        .fb-row {
            display:flex;
            align-items:center;
            gap:0.8vw;
        }
        .fb-slot {
            width:var(--peg-size);
            height:var(--peg-size);
            border-radius:0.6vw;
            border:0.1vw solid rgba(0,0,0,.6);
            display: grid;
        }
        .fb-input {
            width:7vw;
            padding:0.8vw;
            border-radius:0.8vw;
            border:0.1vw solid rgba(255,255,255,.08);
            background: var(--bg);
            color: var(--text);
            font-size:1.5vw;
        }
        .fb-submit {
            padding: 0.8vw 1vw;
            border-radius:0.8vw;
            background:var(--accent);
            color:white;
            border:none;
        }

    </style>
</head>

<body>
    <div id="container">
        <!-- Left Panel -->
        <div id="left" class="section">
            <h1>Mastermind Solver</h1>
            <div class="button-group">
                <div class="button-group" style="border: 0.1vw solid var(--border);">
                    <label for="slots">No of Slots:
                        <input type="number" id="slots" min="1" max="12" value="4">
                    </label>
                    <label for="colors">No of Colors:
                        <input type="number" id="colors" min="1" max="20" value="20">
                    </label>
                    <label id="allowedDuplicates">Allow Duplicate Colors
                        <input type="checkbox" id="buttonDuplicate" checked>
                    </label>
                    <button id="resetSecret" class="btn ghost">Reset secret</button>
                    <button id="randomSecret" class="btn">Random secret</button>
                </div>
                <button id="startSolve" class="btn">Start solver</button>
                <button id="dark">‚òÄÔ∏è Light</button>
                <button id="toggle-sound">üîá Music:Off"</button>
                <div id="displayTime">‚è±Ô∏è 00:00:00</div>
                <div class="message" id="output">
                    Please Click on slot to select/change your secreate colors and press Start solver
                </div>
            </div>
        </div>
        <!-- Right Grid -->
        <div id="right">
            <div class="board" id="secretBoard"></div>
            <div>
                <div class="small">Color palette (click on slot to select/change secreate colors)</div>
                <div class="palette" id="palette"></div>
            </div>
            <div id="visualGuesses"></div>

            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // import { startTimer } from './timer.js';
        // import { playSound } from './sound.js';
        // import { textToSpeechEng } from './speak.js';

        // define variables
        let timer = false;
        let hours = 0;
        let minutes = 0;
        let seconds = 0;
        let hrdsec = 0;
        let slots = 4;
        let nColors = 20;
        let colors = [];
        let secret = [];
        let solverRunning = false;
        let allowDuplicates = true;
        let logsEl, secretBoardEl, paletteEl, visualEl;
        const el = q => document.querySelector(q);
        // function el(q) {
        //     return document.querySelector(q)
        // }

        const colorList = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#fa8072", "#FF4500", "#8b0000", "#008000", "#006400", "#9acd32", "#008080", "#000080", "#00bfff", "#ffd700", "#bdb76b", "#00ced1", "#7fffd4", "#ee82ee", "#9932cc", "#800080", "#9370db",  "#800000", "#A52A2A", "#808000", "#FFC0CB", "#c71585", "#ff1493", "#ff69b4", "#FFA500", "#ff7f50", "#000000", "#808080", "#C0C0C0", "#2f4f4f", "#696969"];

        document.getElementById('output').textContent = "Please Click on slot to select/change your secreate colors and press Start solver";

        const output = document.getElementById('output');
        const toggleThemeBtn = document.getElementById("toggleTheme");

        document.getElementById("buttonDuplicate").onchange = (e) => {
            allowDuplicates = e.target.checked;
            if (allowDuplicates) {
                textToSpeechEng(`Duplicate Colors`);
            } else {
                textToSpeechEng(`Unique Colors`);
            }
        };

        // choose colors from array
        function generateColors() {
            colors = [];
            for (let i = 0; i < nColors; i++) {
                colors.push(colorList[i]);
            }
            renderPalette()
        }

        // display colors list
        function renderPalette() {
            paletteEl.innerHTML = '';
            colors.forEach((c, idx) => {
                const b = document.createElement('button');
                b.className = 'colorBtn';
                b.style.background = c;
                b.textContent = idx; 
                b.style.color = '#fff'; 
                b.style.textShadow='0 0.1vw 0.2vw rgba(0,0,0,.6)'; 
                b.style.fontWeight = 'bold'; 
                b.style.display = 'grid'; 
                b.style.textAlign = 'center'; 
                b.style.alignItems = 'center'; 
                b.onclick = () => {
                    const empty = secret.findIndex(s => s === null);
                    if (empty !== -1) setSecretSlot(empty, idx)
                };
                paletteEl.appendChild(b)
            });
        }

        // remove previous selected secrate colors
        function initSecret() {
            secret = new Array(slots).fill(null);
            renderSecret()
        }

        // set secrate colors
        function setSecretSlot(i, colorIdx) {
            if (colorIdx === null) {
                secret[i] = null; 
                renderSecret(); 
                return
            }
            if (!allowDuplicates) {
                if (secret.includes(colorIdx) && secret[i] !== colorIdx) return
            }
            secret[i] = colorIdx;
            playSound('beep');
            renderSecret()
        }

        // display secrate color in slot (select/change by click)
        function renderSecret() {
            secretBoardEl.innerHTML = ''; 
            for (let i = 0; i < slots; i++) {
                const s = document.createElement('div'); 
                s.className = 'slot'; 
                s.setAttribute('role', 'button'); 
                s.setAttribute('aria-label', `Slot ${i + 1}`); 
                if (secret[i] === null) {
                    s.classList.add('empty') 
                } else {
                    s.style.background = colors[secret[i]] 
                    s.textContent = colors.indexOf(colors[secret[i]]); 
                    s.style.color = '#fff'; 
                    s.style.textShadow='0 0.1vw 0.2vw rgba(0,0,0,.6)'; 
                    s.style.fontWeight = 'bold'; 
                    s.style.display = 'grid'; 
                    s.style.textAlign = 'center'; 
                    s.style.alignItems = 'center'; 
                } // tap to cycle
                s.onclick = () => {
                    playSound('beep');
                    let next = (secret[i] === null) ? 0 : (secret[i] + 1) % nColors; 
                    if (!allowDuplicates) {
                        let tries = 0; 
                        while (tries < nColors && secret.includes(next) && secret[i] !== next) {
                            next = (next + 1) % nColors; tries++; 
                        } 
                        if (tries >= nColors) return; 
                    } 
                    setSecretSlot(i, next) }
                // long press to clear for touch
                let holdT = null;
                s.ontouchstart = s.onpointerdown = () => { 
                    holdT = setTimeout(() => { setSecretSlot(i, null) }, 500) 
                }
                s.ontouchend = s.onpointerup = s.onpointercancel = () => { 
                    if (holdT) clearTimeout(holdT) 
                }
                secretBoardEl.appendChild(s)
            }
        }

        // display log
        function log(...a) {
            const row = document.createElement('div');
            row.textContent = a.join(' ');
            logsEl.appendChild(row);
            logsEl.scrollTop = logsEl.scrollHeight
        }

        // display guess and feedback
        function renderGuessRow(guess, fb) {
            const row = document.createElement('div');
            row.className = 'guessBoard';
            row.style.background = 'rgba(255,255,255,0.02)'; 
            guess.forEach(val => { 
                const peg = document.createElement('div'); 
                peg.className = 'slot'; 
                peg.style.width = 'var(--peg-size)'; 
                peg.style.height = 'var(--peg-size)'; 
                peg.style.borderRadius = '0.6vw'; 
                if (val === null || val === -1) { 
                    peg.classList.add('empty'); 
                } else { peg.style.background = colors[val]; } 
                row.appendChild(peg) 
            });
            const fbText = document.createElement('div');
            fbText.className = 'feedback';
            fbText.textContent = `B=${fb.black} W=${fb.white}`;
            row.appendChild(fbText);
            visualEl.appendChild(row);
            visualEl.scrollTop = visualEl.scrollHeight
        }

        // button listener
        window.addEventListener('DOMContentLoaded', () => {
            logsEl = el('#log');
            secretBoardEl = el('#secretBoard');
            paletteEl = el('#palette');
            visualEl = el('#visualGuesses');
            const slotsInput = el('#slots'), colorsInput = el('#colors'), allowDupInput = el('#buttonDuplicate');
            slotsInput.oninput = () => {
                slots = parseInt(slotsInput.value);
                initSecret();
            };
            colorsInput.oninput = () => {
                nColors = parseInt(colorsInput.value);
                generateColors();
                initSecret()
            };
            allowDupInput.onchange = () => {
                allowDuplicates = allowDupInput.checked; 
                initSecret();
                if (allowDuplicates){
                    textToSpeechEng('allow Duplicates Colors');
                } else {
                    textToSpeechEng('Duplicates Colors not allowed');
                }
            };
            el('#resetSecret').onclick = () => {
                initSecret(); 
                textToSpeechEng('Reset secrate Colors');
            }; el('#randomSecret').onclick = () => {
                textToSpeechEng('random secrate Colors');
                randomSecret(); 
                renderSecret(); 
            };
            el('#startSolve').onclick = () => {
                startSolver()
            };
            generateColors();
            initSecret()
        });

        // select random secrate colors
        function randomSecret() {
            secret = new Array(slots).fill(null);
            if (allowDuplicates) {
                for (let i = 0; i < slots; i++) secret[i] = Math.floor(Math.random() * nColors)
            } else {
                let colors = [...Array(nColors).keys()];
                for (let i = 0; i < slots; i++) {
                    secret[i] = colors.splice(Math.floor(Math.random() * colors.length), 1)[0]
                }
            }
        }

        // solve 
        async function startSolver() {
            timer = true;
            updateTimer();

            if (solverRunning) return;
            if (secret.some(s => s === null)) {
                textToSpeechEng('Choose all slots secret colors');
                output.style.color = 'red';
                output.textContent = 'Choose all slots secret colors';
                // alert('Complete the secret');
                return
            }
            output.style.color = 'var(--text)';
            output.textContent = 'Solving';
            textToSpeechEng('Solving');
            solverRunning = true;
            logsEl.innerHTML = '';
            visualEl.innerHTML = '';
            // log('Solver started - Phase 1 single color in each slot');
            const colorCounts = new Array(nColors).fill(0);

            const triedMap = Object.create(null); // key -> {black,white}

            const keyOf = arr => arr.join(',');

            // for display guess and get feed back
            async function getUserFeedback(internalGuess) {
                const k = keyOf(internalGuess);
                if(triedMap[k]){
                    // log('(cached) feedback for', k, '=>', JSON.stringify(triedMap[k]));
                    renderGuessRow(internalGuess.map(v=>v===null?null:v), triedMap[k]);
                    return triedMap[k];
                }
                return new Promise(resolve => {
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'fb-row';
                    feedbackDiv.style.padding = '0.6vw';
                    feedbackDiv.style.border = '0.1vw solid rgba(255,255,255,.04)';
                    feedbackDiv.style.borderRadius = '0.8vw';
                    feedbackDiv.style.background = 'rgba(255,255,255,0.01)';
                    feedbackDiv.style.justifyContent = 'space-between';
                    feedbackDiv.style.flexWrap = 'wrap';

                    // left: guess display
                    const left = document.createElement('div'); left.style.display = 'flex'; 
                    left.style.alignItems = 'center'; 
                    left.style.gap = '0.6vw';
                    
                    internalGuess.forEach(col => {
                        const s = document.createElement('div'); 
                        s.className='fb-slot';
                        if(col===null||col===-1) { 
                            s.style.background='transparent'; 
                            s.textContent=''; 
                            s.style.border='0.1vw dashed rgba(255,255,255,.06)'; 
                        } else { 
                            s.style.background = colors[col]; 
                            s.textContent = col; 
                            s.style.color = '#fff'; 
                            s.style.textShadow='0 0.1vw 0.2vw rgba(0,0,0,.6)'; 
                            s.style.fontWeight = 'bold'; 
                            s.style.display = 'grid'; 
                            s.style.textAlign = 'center'; 
                            s.style.alignItems = 'center'; 
                        }
                        left.appendChild(s);
                    });
                    feedbackDiv.appendChild(left);

                    // right: inputs
                    const right = document.createElement('div'); right.style.display = 'flex'; 
                    right.style.alignItems = 'center'; 
                    right.style.gap = '0.6vw';
                    const blackInput = document.createElement('input'); 
                    blackInput.type = 'number'; 
                    blackInput.inputMode = 'numeric'; 
                    blackInput.className = 'fb-input'; blackInput.placeholder = 'Black'; 
                    blackInput.min = 0; blackInput.max = slots;
                    const whiteInput = document.createElement('input'); 
                    whiteInput.type = 'number'; 
                    whiteInput.inputMode = 'numeric'; 
                    whiteInput.className = 'fb-input'; 
                    whiteInput.placeholder = 'White'; 
                    whiteInput.min = 0; 
                    whiteInput.max = slots;
                    const submitBtn = document.createElement('button'); 
                    submitBtn.className = 'fb-submit'; 
                    submitBtn.textContent = 'OK';
                    
                    submitBtn.onclick = ()=>{
                        const fb = { black: parseInt(blackInput.value,10)||0, white: parseInt(whiteInput.value,10)||0 };
                        triedMap[k] = fb; // cache
                        feedbackDiv.remove();
                        renderGuessRow(internalGuess, fb);
                        // log('User feedback for', k, '=>', JSON.stringify(fb));
                        resolve(fb);
                    };
                    right.appendChild(blackInput); 
                    right.appendChild(whiteInput); 
                    right.appendChild(submitBtn);
                    feedbackDiv.appendChild(right);

                    visualEl.appendChild(feedbackDiv);
                    // focus first input on mobile
                    setTimeout(() => blackInput.focus(), 80);
                });
            }

            // Phase 1: Probe each color, stop when all slots accounted for
            for (let c = 0; c < nColors; c++) {
                const guess = new Array(slots).fill(c);
                const fb = await getUserFeedback(guess);
                colorCounts[c] = (fb.black || 0) + (fb.white || 0);

                if ((fb.black||0) === slots) {
                    // Found the full secret in one guess
                    const msgColors = document.createElement('div');
                    msgColors.textContent = 'Colors found';
                    msgColors.style.fontWeight = 'bold';
                    visualEl.appendChild(msgColors);
                    renderGuessRow(guess, fb);

                    const msgSecret = document.createElement('div');
                    msgSecret.textContent = 'Secret code found';
                    msgSecret.style.fontWeight = 'bold';
                    visualEl.appendChild(msgSecret);

                    solverRunning = false;
                    return;
                }
                if (colorCounts.reduce((a, b) => a + b, 0) >= slots) break;
                await sleep(120);
            }

            // Phase 2: find position of Only colors found in Phase 1
            const present = [];
            for (let c = 0; c < nColors; c++) {
                if (colorCounts[c] > 0) present.push({ c, count: colorCounts[c] });
            }

            if(present.length === 0){ log('No colors found in Phase1'); solverRunning = false; return; }

              // show found colors
            const foundMsg = document.createElement('div'); foundMsg.textContent='Colors found'; 
            foundMsg.style.fontWeight='700'; 
            visualEl.appendChild(foundMsg);
            const foundArr = [];
            for(const p of present) for(let k=0;k<p.count;k++) foundArr.push(p.c);
            renderGuessRow(foundArr, {black:0, white:0});
            await sleep(300);

            // ----- Phase 2: determine positions using only present colors -----
            // pick filler that's NOT in present if possible
            let filler = colorCounts.findIndex(x => x === 0);
            if (filler === -1) filler = present[0].c;

            const assign = new Array(slots).fill(null);
            let remaining = colorCounts.slice();

            async function getBaseline(assignArr){
                const internal = assignArr.map(v => v===null?filler:v);
                const fb = await getUserFeedback(internal);
                return fb.black || 0;
            }

            for (let pos = 0; pos < slots; pos++) {
                if (assign[pos] !== null) continue;
                const base = await getBaseline(assign);
                // build candidate list (colors with remaining > 0) and randomize order
                let candidates = present.map(p=>p.c).filter(c=>remaining[c] > 0);
                shuffle(candidates);

                for(const c of candidates){
                    // test placing c at pos
                    const testAssign = assign.slice(); 
                    testAssign[pos] = c;
                    const internalGuess = testAssign.map(v => v===null?filler:v);

                    // skip if we've already asked this exact internal guess
                    const k = keyOf(internalGuess);
                    if(triedMap[k]){
                        // log('Skipping already-known guess', k);
                        const cached = triedMap[k];
                        if((cached.black||0) > base){ assign[pos] = c; remaining[c]--; break; }
                        else continue;
                    }

                    const fb = await getUserFeedback(internalGuess);
                    await sleep(80);
                    if((fb.black||0) > base){
                        assign[pos] = c;
                        remaining[c]--;
                        break;
                    }
                }
            }

            // fill any remaining unassigned slots using remaining counts
            for(let i=0;i<slots;i++){
                if(assign[i] === null){
                const idx = remaining.findIndex(x=>x>0);
                if(idx !== -1){ assign[i] = idx; remaining[idx]--; }
                else assign[i] = filler;
                }
            }

            // final verification / display
            const finalInternal = assign.map(v => v===null?filler:v);
            const finalFb = await getUserFeedback(finalInternal);
            const finalMsg = document.createElement('div'); finalMsg.textContent='your Secret colors code is as under'; 
            finalMsg.style.fontWeight='700'; 
            visualEl.appendChild(finalMsg);

            // log('Phase2 complete - Secret code found');
            renderGuessRow(assign, finalFb);
            output.textContent = 'Solved';
            textToSpeechEng('Solved');
            solverRunning = false;
            timer = false;
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms))
        }

        // shuffle helper
        function shuffle(arr) { 
            for(let i=arr.length-1;i>0;i--) {
                const j=Math.floor(Math.random()*(i+1)); 
                [arr[i],arr[j]]=[arr[j],arr[i]] 
            } 
            return arr 
        }

        // theme toggle
        function toggleDarkMode() {
            document.body.classList.toggle("dark");
        }

        // display upadted time of game play
        function displayTime() {
            var displayTime = document.getElementById('displayTime');
            displayTime.textContent = ((hours < 10) ? '0' + hours : hours) + ':' + ((minutes < 10) ? '0' + minutes : minutes) + ':' + ((seconds < 10) ? '0' + seconds : seconds);
        }

        // update of time para
        function updateTimer() {
            if (timer) {
                hrdsec++
                if (hrdsec >= 100) {
                    hrdsec = 0;
                    seconds++;
                    if (seconds >= 60) {
                        seconds = 0;
                        minutes++;
                        if (minutes >= 60) {
                            minutes = 0;
                            hours++;
                        }
                    }
                }
                displayTime();
                setTimeout("updateTimer()", 10);
            }
        }

        //these para to play sound
        function playSound(sound) {
            if (sound == 'beep') {
                var beep = new Audio('assets/sound/tap-sound.mp3');
            } else if (sound == 'win') {
                var beep = new Audio('assets/sound/winner-trumpets.mp3');
            } else if (sound == 'loose') {
                var beep = new Audio('assets/sound/Looser.mp3');
            } else if (sound == 'submit') {
                var beep = new Audio('assets/sound/inhalation-and-exhalation.mp3');
            }
            beep.play();
        }

        // Sound objects
        const sounds = {
            click: new Audio('assets/sound/tap-sound.mp3'),
            beep: new Audio('assets/sound/Clock-ticking-Turning-one.mp3'),
            submit: new Audio('assets/sound/inhalation-and-exhalation.mp3'),
            win: new Audio('assets/sound/winner-trumpets.mp3'),
            loose: new Audio('assets/sound/Looser.mp3'),
            bg: new Audio('assets/sound/bg-music.mp3'),
            fire: new Audio('assets/sound/fireworks.mp3')
        };

        let soundEnabled = false;

        document.getElementById("toggle-sound").addEventListener("click", () => {
            soundEnabled = !soundEnabled;
            document.getElementById("toggle-sound").textContent = soundEnabled ? "üîä Sound: On" : "üîá Sound: Off";
            if (soundEnabled) sounds.bg.play();
            else sounds.bg.pause();
        });

        // Play sound helper
        function playSound(type) {
            if (sounds[type]) {
                sounds[type].currentTime = 0;
                sounds[type].play();
            }
        }

        // background music during page load and play
        window.addEventListener("load", () => {
            if (soundEnabled) playSound('bg');
        });

        //toggle theme
        document.getElementById("dark").addEventListener("click", () => {
            document.body.classList.toggle("dark");
            if (document.body.classList.contains("dark")) {
                document.getElementById("dark").innerText = "‚òÄÔ∏è Light";
                textToSpeechEng('Theme Dark');
            } else {
                document.getElementById("dark").innerText = "üåô Dark";
                textToSpeechEng('Theme Light');
            }
        });

        // para to speeach in english
        // export function textToSpeechEng(text) {
        function textToSpeechEng(text) {
            let speechSynthesis = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance();
            utterance.lang = "en-US";
            utterance.voice = speechSynthesis.getVoices().find(voice => voice.lang === 'en-US');
            utterance.text = text;
            speechSynthesis.speak(utterance);
        }
    </script>
</body>

</html>